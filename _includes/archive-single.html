{% include base_path %}

{% if post.header.teaser %}
  {% capture teaser %}{{ post.header.teaser }}{% endcapture %}
{% else %}
  {% assign teaser = site.teaser %}
{% endif %}

{% if post.id %}
  {% assign title = post.title | markdownify | remove: "<p>" | remove: "</p>" %}
{% else %}
  {% assign title = post.title %}
{% endif %}

<div class="{{ include.type | default: "list" }}__item">
  <article class="archive__item publication-item" itemscope itemtype="http://schema.org/ScholarlyArticle">
    {% if include.type == "grid" and teaser %}
      <div class="archive__item-teaser">
        <img src=
          {% if teaser contains "://" %}
            "{{ teaser }}"
          {% else %}
            "{{ teaser | prepend: "/images/" | prepend: base_path }}"
          {% endif %}
          alt="">
      </div>
    {% endif %}

    <h2 class="archive__item-title" itemprop="headline">
      {% if post.link %}
        <a href="{{ post.link }}" itemprop="url">{{ title }}</a>
      {% else %}
        <a href="{{ base_path }}{{ post.url }}" rel="permalink" itemprop="url">{{ title }}</a>
      {% endif %}
    </h2>
    
    <!-- 作者信息 -->
    {% if post.authors %}
      <div class="authors" itemprop="author">
        {{ post.authors | markdownify | remove: "<p>" | remove: "</p>" }}
      </div>
    {% endif %}

    <!-- 出版信息 -->
    <div class="venue" itemprop="isPartOf">
      {% if post.collection == 'publications' %}
        {% if post.venue %}
          Published in <i>{{ post.venue }}</i>
        {% endif %}
        {% if post.date %}
          , {{ post.date | default: "1900-01-01" | date: "%Y" }}
        {% endif %}
        {% if post.note %}
          <span class="publication-note">({{ post.note }})</span>
        {% endif %}
      {% endif %}
    </div>

    <!-- 论文链接 -->
    <div class="publication-links">
      {% if post.paperurl %}
        <a href="{{ post.paperurl }}" target="_blank" itemprop="url">PDF</a>
      {% endif %}
      {% if post.slidesurl %}
        <a href="{{ post.slidesurl }}" target="_blank">Slides</a>
      {% endif %}
      {% if post.codeurl %}
        <a href="{{ post.codeurl }}" target="_blank">Code</a>
      {% endif %}
      {% if post.bibtex %}
        <a href="#" class="show-bibtex" data-bibtex="{{ post.bibtex | replace: '"', '&quot;' | escape }}">BibTeX</a>
      {% endif %}
      {% if post.link %}
        <a href="{{ post.link }}" target="_blank">Link</a>
      {% endif %}
    </div>

    <!-- BibTeX内容区域 -->
    {% if post.bibtex %}
      <div class="bibtex-content" style="display: none;">
        <pre style="margin: 0; white-space: pre-wrap; font-family: 'Courier New', monospace;"><code>{{ post.bibtex }}</code></pre>
      </div>
    {% endif %}

    {% if post.excerpt and site.read_more != 'enabled' %}
      <div class="archive__item-excerpt" itemprop="description">
        {{ post.excerpt | markdownify }}
      </div>
    {% elsif post.excerpt and site.read_more == 'enabled' %}
      <div class="archive__item-excerpt" itemprop="description">
        {{ post.excerpt | markdownify | remove: '<p>' | remove: '</p>' }}
        <strong><a href="{{ base_path }}{{ post.url }}" rel="permalink">Read more</a></strong>
      </div>
    {% endif %}

  </article>
</div>

<script>
// BibTeX显示/隐藏功能
document.addEventListener('DOMContentLoaded', function() {
  const bibtexLinks = document.querySelectorAll('.show-bibtex');
  
  bibtexLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const bibtexContent = this.closest('.publication-item').querySelector('.bibtex-content');
      const isVisible = bibtexContent.style.display === 'block';
      
      // 隐藏所有其他打开的BibTeX内容
      document.querySelectorAll('.bibtex-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // 切换当前BibTeX内容的显示状态
      bibtexContent.style.display = isVisible ? 'none' : 'block';
      
      // 滚动到BibTeX内容
      if (!isVisible) {
        bibtexContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    });
  });
});
</script>
